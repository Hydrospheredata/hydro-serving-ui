FROM nginx:1.15-alpine

ENV MANAGER_HOST=localhost
ENV GATEWAY_HOST=localhost
ENV MONITORING_HOST=localhost
ENV REQSTORE_HOST=localhost

ENV MANAGER_HTTP_PORT=8080
ENV MANAGER_GRPC_PORT=9090
ENV GATEWAY_HTTP_PORT=8080
ENV GATEWAY_GRPC_PORT=9090
ENV MONITORING_HTTP_PORT=8080
ENV MONITORING_GRPC_PORT=9090
ENV REQSTORE_HTTP_PORT=8080
ENV REQSTORE_GRPC_PORT=9090

EXPOSE 80

ADD nginx/config/default.conf.template /etc/nginx/conf.d/default.conf.template
COPY hydro-serving-ui /usr/share/nginx/html

CMD envsubst '${MANAGER_HOST} ${GATEWAY_HOST} ${MONITORING_HOST} ${REQSTORE_HOST} ${MANAGER_HTTP_PORT} ${MANAGER_GRPC_PORT} ${GATEWAY_HTTP_PORT} ${GATEWAY_GRPC_PORT} ${MONITORING_HTTP_PORT} ${MONITORING_GRPC_PORT} ${REQSTORE_HTTP_PORT}' < /etc/nginx/conf.d/default.conf.template > /etc/nginx/conf.d/default.conf \
 && cat /etc/nginx/conf.d/default.conf \
 && exec nginx -g 'daemon off;'
